<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BOM → Mouser Template Converter</title>
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      max-width:1100px;margin:18px auto;padding:0 14px;
    }
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:12px 0;background:#fff;}
    button{padding:10px 14px;border:0;border-radius:12px;background:#111827;color:#fff;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    pre{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px;overflow:auto;}
    .muted{color:#6b7280;font-size:13px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .grid{display:grid;grid-template-columns: 1fr;gap:12px;}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;color:#111827;background:#f9fafb;}
    .warn{color:#b45309;font-size:13px;white-space:pre-wrap;}

    .tableWrap{
      border:1px solid #e5e7eb;border-radius:14px;overflow:auto;max-height:520px;
      position:relative;
    }
    table{border-collapse:collapse;width:100%;min-width:920px;}
    th, td{border-bottom:1px solid #f1f5f9;border-right:1px solid #f1f5f9;padding:6px 8px;font-size:13px;white-space:nowrap;}
    th{position:sticky;top:0;background:#f9fafb;z-index:2;text-align:left;}
    td{background:#fff;}
    tr:hover td{background:#fcfcfd;}
    .rowIndex{position:sticky;left:0;background:#f9fafb;z-index:3;font-weight:600;}
    .cellIndex{color:#94a3b8;font-size:12px;}

    tr.headerCandidate td{background:#fff7ed !important;}
    tr.headerCandidate td.rowIndex{background:#ffedd5 !important;}

    td.selectMPN{outline:2px solid #2563eb; outline-offset:-2px;}
    td.selectQTY{outline:2px solid #16a34a; outline-offset:-2px;}
    td.clickable{cursor:pointer;}

    .toolbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px;border:1px solid #e5e7eb;border-radius:14px;background:#f9fafb;
    }
    .toolbar button{background:#111827;}
    .toolbar .ghost{background:#fff;color:#111827;border:1px solid #e5e7eb;}
    .kv{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .kv b{color:#111827;}
    .mapBox{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff;}
    .small{font-size:12px;color:#6b7280;}
  </style>
</head>
<body>
  <h1>BOM → Mouser Template (.xlsx)</h1>
  <p class="muted">
    Upload → preview table (auto-jumps to likely header rows) → click one MPN cell + one QTY cell → Convert → Download
  </p>

  <div class="card">
    <h2>1) Select a file</h2>
    <input id="file" type="file" accept=".csv,.txt,.tsv,.xls,.xlsx" />
    <p class="muted" id="fileInfo"></p>

    <div class="row" style="margin-top:10px;">
      <button id="btnUpload">Upload & Preview</button>
      <span class="muted" id="status"></span>
      <span class="pill" id="stagePill">Stage: idle</span>
    </div>
  </div>

  <div class="card" id="previewCard" style="display:none;">
    <h2>2) Preview table</h2>

    <div class="toolbar">
      <span class="pill" id="autoJumpPill">Auto-jump: -</span>
      <button class="ghost" id="btnNextCandidate" type="button">Go to next candidate</button>
      <span class="muted" id="guideText">Guide: After upload, click an MPN cell first.</span>
    </div>

    <div class="grid">
      <div class="tableWrap" id="tableWrap"></div>

      <div class="mapBox">
        <div class="kv">
          <b>Selection:</b>
          <span id="mpnState" class="small">MPN: not selected</span>
          <span class="small">|</span>
          <span id="qtyState" class="small">QTY: not selected</span>
          <span class="small">|</span>
          <span id="headerState" class="small">Header row: (auto inferred)</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <label class="small"><input type="checkbox" id="chkAgg" /> Aggregate same MPN (sum quantities)</label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnConvert" disabled>Convert & Download (Mouser .xlsx)</button>
          <span class="muted" id="convertStatus"></span>
        </div>

        <div id="warnings" class="warn" style="margin-top:10px;"></div>

        <div id="downloadArea" style="display:none;margin-top:10px;">
          <p class="muted" style="margin:0;">If auto-download is blocked, click the link below.</p>
          <a id="downloadLink" href="#" download="">Download mouser_bom.xlsx</a>
        </div>
      </div>
    </div>

    <h3>Server Response (debug)</h3>
    <pre id="out">{}</pre>
  </div>

<script>
  const fileEl = document.getElementById('file');
  const fileInfoEl = document.getElementById('fileInfo');
  const btnUpload = document.getElementById('btnUpload');
  const statusEl = document.getElementById('status');
  const stagePill = document.getElementById('stagePill');

  const previewCard = document.getElementById('previewCard');
  const tableWrap = document.getElementById('tableWrap');
  const outEl = document.getElementById('out');

  const guideText = document.getElementById('guideText');
  const autoJumpPill = document.getElementById('autoJumpPill');
  const btnNextCandidate = document.getElementById('btnNextCandidate');

  const mpnState = document.getElementById('mpnState');
  const qtyState = document.getElementById('qtyState');
  const headerState = document.getElementById('headerState');

  const chkAgg = document.getElementById('chkAgg');
  const btnConvert = document.getElementById('btnConvert');
  const convertStatus = document.getElementById('convertStatus');

  const warningsEl = document.getElementById('warnings');
  const downloadArea = document.getElementById('downloadArea');
  const downloadLink = document.getElementById('downloadLink');

  const MAX_BYTES = 8 * 1024 * 1024;

  let token = null;
  let preview = null;

  let selectedMPN = null;
  let selectedQTY = null;
  let headerRowIndex = null;
  let dataStartRowIndex = null;
  let mpnColIndex = null;
  let qtyColIndex = null;

  let headerCandidates = [];
  let candidatePtr = 0;

  function setStage(s){ stagePill.textContent = `Stage: ${s}`; }

  function resetAll() {
    token = null;
    preview = null;
    selectedMPN = null;
    selectedQTY = null;
    headerRowIndex = null;
    dataStartRowIndex = null;
    mpnColIndex = null;
    qtyColIndex = null;
    headerCandidates = [];
    candidatePtr = 0;

    tableWrap.innerHTML = '';
    outEl.textContent = '{}';
    warningsEl.textContent = '';
    downloadArea.style.display = 'none';
    btnConvert.disabled = true;
    convertStatus.textContent = '';

    mpnState.textContent = 'MPN: not selected';
    qtyState.textContent = 'QTY: not selected';
    headerState.textContent = 'Header row: (auto inferred)';
    autoJumpPill.textContent = 'Auto-jump: -';
    guideText.textContent = 'Guide: After upload, click an MPN cell first.';
    setStage('idle');
  }

  fileEl.addEventListener('change', () => {
    const f = fileEl.files && fileEl.files[0];
    resetAll();
    previewCard.style.display = 'none';
    statusEl.textContent = '';
    if (!f) { fileInfoEl.textContent = ''; return; }
    fileInfoEl.textContent = `Selected: ${f.name} (${f.type || 'unknown'}) / ${f.size} bytes`;
    if (f.size > MAX_BYTES) statusEl.textContent = `File too large (limit ${MAX_BYTES} bytes).`;
  });

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function isNumericLike(v) {
    if (v === null || v === undefined) return false;
    if (typeof v === 'number') return isFinite(v);
    const s = String(v).trim();
    if (!s) return false;
    const n = Number(s.replace(/,/g,''));
    return isFinite(n);
  }

  function rowScoreForHeader(values, r) {
    const row = values[r] || [];
    let nonEmpty = 0, numericLike = 0, strLike = 0;
    const seen = new Set();
    let dup = 0;

    for (const cell of row) {
      const s = (cell === null || cell === undefined) ? "" : String(cell).trim();
      if (!s) continue;
      nonEmpty++;
      if (isNumericLike(cell)) numericLike++;
      else strLike++;
      if (seen.has(s)) dup++;
      else seen.add(s);
    }
    if (nonEmpty === 0) return -999;

    const next = values[r+1] || [];
    let nextNumeric = 0, nextNonEmpty = 0;
    for (const cell of next) {
      const s = (cell === null || cell === undefined) ? "" : String(cell).trim();
      if (!s) continue;
      nextNonEmpty++;
      if (isNumericLike(cell)) nextNumeric++;
    }

    const numericRatio = numericLike / nonEmpty;
    const nextNumericRatio = nextNonEmpty ? (nextNumeric / nextNonEmpty) : 0;

    const joined = row.map(x => (x===null||x===undefined) ? "" : String(x).toLowerCase()).join(" ");
    const tokenBoost =
      (/\b(qty|quantity)\b/.test(joined) ? 2.0 : 0) +
      (/\b(mpn|part|p\/n|pn|partnumber|part number)\b/.test(joined) ? 2.0 : 0) +
      (/\b(mfr|manufacturer|maker|vendor)\b/.test(joined) ? 1.0 : 0) +
      (/\b(refdes|reference|designator)\b/.test(joined) ? 0.8 : 0);

    const strRatio = strLike / nonEmpty;
    const dupPenalty = dup * 0.3;

    let score = 0;
    score += strRatio * 4.0;
    score += (1 - numericRatio) * 2.0;
    score += Math.max(0, nextNumericRatio - numericRatio) * 1.5;
    score += tokenBoost;
    score -= dupPenalty;

    return score;
  }

  function computeHeaderCandidates(values) {
    const N = Math.min(60, values.length);
    const scored = [];
    for (let r = 0; r < N; r++) scored.push({ r, score: rowScoreForHeader(values, r) });
    scored.sort((a,b) => b.score - a.score);
    return scored.filter(x => x.score > -100).slice(0, 10).map(x => x.r);
  }

  function renderTable(values) {
    const rowCount = values.length;
    const colCount = values[0] ? values[0].length : 0;

    let html = '<table><thead><tr>';
    html += '<th class="rowIndex">#</th>';
    for (let c = 0; c < colCount; c++) {
      html += `<th>Col ${c+1}<div class="cellIndex">${String.fromCharCode(65 + (c % 26))}</div></th>`;
    }
    html += '</tr></thead><tbody>';

    for (let r = 0; r < rowCount; r++) {
      html += `<tr data-r="${r}">`;
      html += `<td class="rowIndex">${r+1}</td>`;
      for (let c = 0; c < colCount; c++) {
        const v = values[r][c];
        const show = (v === null || v === undefined) ? "" : String(v);
        html += `<td class="clickable" data-r="${r}" data-c="${c}">${escapeHtml(show)}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';

    tableWrap.innerHTML = html;
    tableWrap.querySelectorAll('td.clickable').forEach(td => td.addEventListener('click', () => onCellClick(td)));
  }

  function clearCellClasses() {
    tableWrap.querySelectorAll('td.selectMPN, td.selectQTY').forEach(td => td.classList.remove('selectMPN','selectQTY'));
  }

  function highlightSelectedCells() {
    clearCellClasses();
    if (selectedMPN) {
      const sel = tableWrap.querySelector(`td[data-r="${selectedMPN.r}"][data-c="${selectedMPN.c}"]`);
      if (sel) sel.classList.add('selectMPN');
    }
    if (selectedQTY) {
      const sel = tableWrap.querySelector(`td[data-r="${selectedQTY.r}"][data-c="${selectedQTY.c}"]`);
      if (sel) sel.classList.add('selectQTY');
    }
  }

  function markHeaderCandidateRow(r) {
    tableWrap.querySelectorAll('tr.headerCandidate').forEach(tr => tr.classList.remove('headerCandidate'));
    const tr = tableWrap.querySelector(`tr[data-r="${r}"]`);
    if (tr) tr.classList.add('headerCandidate');
  }

  function scrollRowIntoView(r) {
    const tr = tableWrap.querySelector(`tr[data-r="${r}"]`);
    if (tr) tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function inferHeaderFromClick(dataRowIndex) {
    const values = preview.values;
    const upper = Math.min(dataRowIndex, values.length - 1);
    let bestR = 0, bestScore = -1e9;
    for (let r = 0; r <= upper; r++) {
      const s = rowScoreForHeader(values, r);
      if (s > bestScore) { bestScore = s; bestR = r; }
    }
    return bestR;
  }

  function updateMappingStateUI() {
    mpnState.textContent = selectedMPN ? `MPN: row ${selectedMPN.r+1}, col ${selectedMPN.c+1}` : 'MPN: not selected';
    qtyState.textContent = selectedQTY ? `QTY: row ${selectedQTY.r+1}, col ${selectedQTY.c+1}` : 'QTY: not selected';

    if (headerRowIndex !== null) {
      headerState.textContent = `Header row: ${headerRowIndex+1} (data starts at ${dataStartRowIndex+1})`;
    } else {
      headerState.textContent = 'Header row: (auto inferred)';
    }

    const ok = (mpnColIndex !== null && qtyColIndex !== null && dataStartRowIndex !== null);
    btnConvert.disabled = !ok;
  }

  function onCellClick(td) {
    const r = Number(td.getAttribute('data-r'));
    const c = Number(td.getAttribute('data-c'));
    const ev = window.event;

    if (!selectedMPN) {
      selectedMPN = { r, c };
      mpnColIndex = c;

      headerRowIndex = inferHeaderFromClick(r);
      dataStartRowIndex = headerRowIndex + 1;

      guideText.textContent = 'Guide: Now click a QTY cell once.';
      autoJumpPill.textContent = `Auto-jump: header candidate row ${headerRowIndex+1}`;
      markHeaderCandidateRow(headerRowIndex);
      scrollRowIntoView(headerRowIndex);

      highlightSelectedCells();
      updateMappingStateUI();
      return;
    }

    if (!selectedQTY) {
      selectedQTY = { r, c };
      qtyColIndex = c;

      guideText.textContent = 'Guide: Done. Click Convert to download the Mouser template.';
      highlightSelectedCells();
      updateMappingStateUI();
      return;
    }

    // Reselect: Shift = MPN, Alt = QTY
    if (ev && ev.shiftKey) {
      selectedMPN = { r, c };
      mpnColIndex = c;
      headerRowIndex = inferHeaderFromClick(r);
      dataStartRowIndex = headerRowIndex + 1;
      markHeaderCandidateRow(headerRowIndex);
      scrollRowIntoView(headerRowIndex);
      guideText.textContent = 'Guide: MPN reselected. Reselect QTY if needed.';
    } else if (ev && ev.altKey) {
      selectedQTY = { r, c };
      qtyColIndex = c;
      guideText.textContent = 'Guide: QTY reselected. You can proceed with Convert.';
    }

    highlightSelectedCells();
    updateMappingStateUI();
  }

  // Upload
  btnUpload.addEventListener('click', async () => {
    const f = fileEl.files && fileEl.files[0];
    if (!f) { alert('Please select a file first.'); return; }
    if (f.size > MAX_BYTES) { alert('File is too large (8MB limit).'); return; }

    resetAll();
    previewCard.style.display = 'block';
    btnUpload.disabled = true;
    statusEl.textContent = 'Reading file...';
    setStage('reading');

    try {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(f);
      });

      statusEl.textContent = 'Uploading & building preview...';
      setStage('uploading');

      google.script.run
        .withSuccessHandler((res) => {
          outEl.textContent = JSON.stringify(res, null, 2);

          if (res && res.ok && res.preview && res.preview.values) {
            token = res.token;
            preview = res.preview;

            renderTable(preview.values);

            headerCandidates = computeHeaderCandidates(preview.values);
            candidatePtr = 0;

            const first = (headerCandidates.length ? headerCandidates[0] : 0);
            markHeaderCandidateRow(first);
            scrollRowIntoView(first);

            autoJumpPill.textContent = `Auto-jump: candidate row ${first+1}`;
            guideText.textContent = 'Guide: Click an MPN cell once. (Shift=reselect MPN, Alt=reselect QTY)';
            setStage('preview');
            statusEl.textContent = 'Preview ready ✅';
          } else {
            statusEl.textContent = 'Failed ❌ (no preview)';
            setStage('error');
          }

          btnUpload.disabled = false;
        })
        .withFailureHandler((err) => {
          outEl.textContent = String(err);
          statusEl.textContent = 'Failed ❌ (script error)';
          setStage('error');
          btnUpload.disabled = false;
        })
        .uploadAndGetPreview({ filename: f.name, mimeType: f.type || '', dataUrl });
    } catch (e) {
      outEl.textContent = String(e);
      statusEl.textContent = 'Failed ❌ (file read error)';
      setStage('error');
      btnUpload.disabled = false;
    }
  });

  btnNextCandidate.addEventListener('click', () => {
    if (!headerCandidates.length) return;
    candidatePtr = (candidatePtr + 1) % headerCandidates.length;
    const r = headerCandidates[candidatePtr];
    markHeaderCandidateRow(r);
    scrollRowIntoView(r);
    autoJumpPill.textContent = `Auto-jump: candidate row ${r+1} (${candidatePtr+1}/${headerCandidates.length})`;
  });

  function triggerDownload(dataUrl, filename) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename || 'mouser_bom.xlsx';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Convert & Download
  btnConvert.addEventListener('click', () => {
    if (!token || !token.sheetId) { alert('Please upload a file first.'); return; }
    if (mpnColIndex === null || qtyColIndex === null || dataStartRowIndex === null) {
      alert('Please click one MPN cell and one QTY cell.');
      return;
    }

    btnConvert.disabled = true;
    convertStatus.textContent = 'Converting...';
    warningsEl.textContent = '';
    downloadArea.style.display = 'none';
    setStage('converting');

    const req = {
      token,
      mapping: {
        headerRowIndex,
        dataStartRowIndex,
        mpnColIndex,
        qtyColIndex,
        aggregateSameMpn: chkAgg.checked
      }
    };

    google.script.run
      .withSuccessHandler((res) => {
        outEl.textContent = JSON.stringify(res, null, 2);

        if (res && res.ok && res.download && res.download.dataUrl) {
          if (res.warnings && res.warnings.length) {
            warningsEl.textContent = "Warnings:\n- " + res.warnings.join("\n- ");
          } else {
            warningsEl.textContent = "";
          }

          downloadLink.href = res.download.dataUrl;
          downloadLink.download = res.download.filename || 'mouser_bom.xlsx';
          downloadArea.style.display = 'block';

          try {
            triggerDownload(res.download.dataUrl, downloadLink.download);
            convertStatus.textContent = 'Done ✅ (download triggered)';
          } catch (e) {
            convertStatus.textContent = 'Done ✅ (auto-download blocked; use the link below)';
          }

          setStage('done');
        } else {
          convertStatus.textContent = 'Failed ❌ (no download data)';
          setStage('error');
        }

        btnConvert.disabled = false;
      })
      .withFailureHandler((err) => {
        outEl.textContent = String(err);
        convertStatus.textContent = 'Failed ❌ (script error)';
        setStage('error');
        btnConvert.disabled = false;
      })
      .convertToMouserTemplate(req);
  });

  resetAll();
</script>
</body>
</html>
